<?php

require_once __DIR__.'/layout/head.phtml';
?>

<?php
require_once __DIR__.'/layout/header.phtml';
?>

	<script>
		function autoRefresh() {
			window.location = window.location.href;
		}
		setInterval('autoRefresh()', 5*60*1000); // refresh every 5 minutes
	</script>

	<!-- Begin page content -->
	<main role="main" class="container">

		<h1> <?= $page ["title"] ?> </h1>
		
		<table class="table table-bordered my-3">
			<tr>
				<th class="text-center">unix user</th>
				<th class="text-center">repo name</th>
				<th class="text-center">repo size</th>
				<th class="text-center"># archives</th>
				<th class="text-center">last archive </th>
				<th class="text-center">original size</th>
			</tr>

<?php
$total["user_count"] = 0;
$total["repo_count"] = 0;
$total["repo_size"] = 0;
$total["archive_count"] = 0;
$total["last_archive_datetime"] = "9999";
$total["last_archive_original_size"] = 0;
foreach ($data as $user_name => $user) {
	$total["user_count"] ++;
	$user_repo_cpt = 1;
	foreach ($user as $repo_name => $repo) {
		$total["repo_count"] ++;
		$repo_label = $conf ["repos"] [$user_name] [$repo_name];
		?>
		<tr>
			<?php
			if ($user_repo_cpt === 1) { // first column which can overlap many rows
				?>
				<td rowspan="<?= count($user) ?>" class="align-middle"><?= $conf ["users"] [$user_name] ?></td>
				<?php
			}
			
			?>
			<td>
				<a href="<?= $BASE . $f3->alias("repository", ["user_name" => $user_name, "repo_name" => $repo_name], []) ?>"
					class="<?= empty($repo ["list"]) ? "text-body text-decoration-none pe-none" : "" ?>" title="<?= $repo_name ?>"><?= $repo_label ?></a>
			</td>
			<?php
			
			if(!empty($repo ["info"]) && !empty($repo ["list"])) {
				$repo_size = $repo ["info"] ["cache"] ["stats"] ["unique_csize"];
				$total["repo_size"] += $repo_size;
				$archive_count = count($repo ["list"] ["archives"]);
				$total["archive_count"] += $archive_count;
				?>
				<td class="text-end"><?= ByteUnits\Binary::bytes($repo_size)->format("GiB", " ") ?></td>
				<td class="text-end"><?= $archive_count ?></td>

				<?php
				$last_archive = $repo ["last_archive"];
				if(!empty($last_archive)) {
					$start = $last_archive ["archives"] [0] ["start"];
					$dt = new DateTime($start);
					$start_formated = $dt->format("d/m H:i");
					$original_size = $last_archive ["archives"] [0] ["stats"] ["original_size"];
					$total["last_archive_datetime"] = min($total["last_archive_datetime"], $start);
					$total["last_archive_original_size"] += $original_size;
					?>
					<td class="text-end"><?= $start_formated ?></td>
					<td class="text-end"><?= ByteUnits\Binary::bytes($original_size)->format("GiB", " ") ?></td>
					<?php
				}
				else {
					?>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<?php
				}
			}
			else { // cache return empty value. will be fixed only when cache is correctly filled
				?>
				<td> &nbsp; </td>
				<td> &nbsp; </td>
				<td> &nbsp; </td>
				<td> &nbsp; </td>
				<?php
			}
			?>
		</tr>
		<?php
		$user_repo_cpt ++;
	}
}
?>

				<tr>
					<th> <?= $total["user_count"] ?> </th>
					<th> <?= $total["repo_count"] ?> </th>
					<th class="text-end"><?= ByteUnits\Binary::bytes($total["repo_size"])->format("GiB", " ") ?></th>
					<th class="text-end"><?= $total["archive_count"] ?></th>
					<th class="text-end"><?= (new DateTime($total["last_archive_datetime"]))->format("d/m H:i") ?></th>
					<th class="text-end"><?= ByteUnits\Binary::bytes($total["last_archive_original_size"])->format("GiB", " ") ?></th>
				</tr>
		</table>

	</main>

<?php
require_once __DIR__.'/layout/footer.phtml';
?>

<?php
require_once __DIR__.'/layout/foot.phtml';
?>
